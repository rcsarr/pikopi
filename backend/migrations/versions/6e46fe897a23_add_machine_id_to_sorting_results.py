"""Add machine_id to sorting_results

Revision ID: 6e46fe897a23
Revises: 
Create Date: 2025-11-23 23:42:56.756624

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '6e46fe897a23'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('forum_likes', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('idx_likes_message_id'))
        batch_op.drop_index(batch_op.f('idx_likes_user_id'))

    op.drop_table('forum_likes')
    with op.batch_alter_table('forum_message_likes', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               type_=sa.BigInteger(),
               existing_nullable=False,
               autoincrement=True)
        batch_op.drop_constraint(batch_op.f('forum_message_likes_message_id_user_id_key'), type_='unique')
        batch_op.drop_index(batch_op.f('idx_forum_message_likes_message_id'))
        batch_op.drop_index(batch_op.f('idx_forum_message_likes_user_id'))
        batch_op.create_unique_constraint('unique_message_like', ['message_id', 'user_id'])

    with op.batch_alter_table('forum_messages', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.String(length=50),
               existing_nullable=False)
        batch_op.alter_column('thread_id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.String(length=50),
               existing_nullable=False)
        batch_op.alter_column('author_id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.String(length=50),
               existing_nullable=False)
        batch_op.alter_column('author_name',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=255),
               existing_nullable=False)
        batch_op.alter_column('author_role',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.String(length=10),
               existing_nullable=False)
        batch_op.alter_column('parent_message_id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.String(length=50),
               existing_nullable=True)
        batch_op.drop_index(batch_op.f('idx_messages_author_id'))
        batch_op.drop_index(batch_op.f('idx_messages_created_at'))
        batch_op.drop_index(batch_op.f('idx_messages_parent_id'))
        batch_op.drop_index(batch_op.f('idx_messages_thread_id'))
        batch_op.create_foreign_key(None, 'users', ['author_id'], ['id'], ondelete='CASCADE')

    with op.batch_alter_table('forum_threads', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.String(length=50),
               existing_nullable=False)
        batch_op.alter_column('title',
               existing_type=sa.VARCHAR(length=255),
               type_=sa.String(length=500),
               existing_nullable=False)
        batch_op.alter_column('author_id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.String(length=50),
               existing_nullable=False)
        batch_op.alter_column('author_name',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=255),
               existing_nullable=False)
        batch_op.alter_column('author_role',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.String(length=10),
               existing_nullable=False)
        batch_op.alter_column('category',
               existing_type=sa.VARCHAR(length=50),
               type_=sa.String(length=20),
               existing_nullable=False)
        batch_op.drop_index(batch_op.f('idx_threads_author_id'))
        batch_op.drop_index(batch_op.f('idx_threads_category'))
        batch_op.drop_index(batch_op.f('idx_threads_created_at'))
        batch_op.drop_index(batch_op.f('idx_threads_is_locked'))
        batch_op.drop_index(batch_op.f('idx_threads_is_pinned'))
        batch_op.drop_index(batch_op.f('idx_threads_last_activity'))
        batch_op.drop_index(batch_op.f('idx_threads_views_count'))
        batch_op.create_foreign_key(None, 'users', ['author_id'], ['id'], ondelete='CASCADE')

    with op.batch_alter_table('news', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.String(length=50),
               existing_nullable=False)
        batch_op.alter_column('title',
               existing_type=sa.VARCHAR(length=255),
               type_=sa.String(length=500),
               existing_nullable=False)
        batch_op.alter_column('excerpt',
               existing_type=sa.TEXT(),
               type_=sa.String(length=500),
               existing_nullable=True)
        batch_op.alter_column('author_id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.String(length=50),
               nullable=False)
        batch_op.alter_column('author_name',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=255),
               existing_nullable=False)
        batch_op.alter_column('category',
               existing_type=sa.VARCHAR(length=50),
               type_=sa.String(length=20),
               existing_nullable=False)
        batch_op.alter_column('slug',
               existing_type=sa.VARCHAR(length=255),
               type_=sa.String(length=500),
               existing_nullable=True)
        batch_op.drop_index(batch_op.f('idx_author'))
        batch_op.drop_index(batch_op.f('idx_author_id'))
        batch_op.drop_index(batch_op.f('idx_category'))
        batch_op.drop_index(batch_op.f('idx_published'))
        batch_op.drop_index(batch_op.f('idx_published_at'))
        batch_op.drop_index(batch_op.f('idx_slug'))
        batch_op.create_unique_constraint(None, ['slug'])
        batch_op.create_foreign_key(None, 'users', ['author_id'], ['id'], ondelete='CASCADE')

    with op.batch_alter_table('notifications', schema=None) as batch_op:
        batch_op.alter_column('title',
               existing_type=sa.VARCHAR(length=500),
               type_=sa.String(length=255),
               existing_nullable=False)
        batch_op.alter_column('type',
               existing_type=sa.VARCHAR(length=30),
               type_=sa.String(length=50),
               nullable=True)
        batch_op.alter_column('link',
               existing_type=sa.VARCHAR(length=500),
               type_=sa.String(length=255),
               existing_nullable=True)

    with op.batch_alter_table('orders', schema=None) as batch_op:
        batch_op.alter_column('package_name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='Paket: Starter, Bisnis, Enterprise',
               existing_nullable=False)
        batch_op.alter_column('weight',
               existing_type=sa.NUMERIC(precision=10, scale=2),
               type_=sa.Float(),
               comment=None,
               existing_comment='Berat biji kopi (kg)',
               existing_nullable=False)
        batch_op.alter_column('price',
               existing_type=sa.NUMERIC(precision=15, scale=2),
               type_=sa.Float(),
               existing_nullable=False)
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=50),
               type_=sa.String(length=20),
               existing_nullable=True,
               existing_server_default=sa.text("'pending'::character varying"))
        batch_op.alter_column('payment_status',
               existing_type=sa.VARCHAR(length=50),
               type_=sa.String(length=20),
               existing_nullable=True,
               existing_server_default=sa.text("'unpaid'::character varying"))
        batch_op.alter_column('customer_name',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='Nama lengkap pelanggan',
               existing_nullable=True)
        batch_op.alter_column('customer_phone',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='Nomor telepon/WhatsApp pelanggan',
               existing_nullable=True)
        batch_op.alter_column('customer_email',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='Email pelanggan',
               existing_nullable=True)
        batch_op.alter_column('customer_address',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='Alamat lengkap untuk pickup/delivery',
               existing_nullable=True)
        batch_op.alter_column('coffee_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='Jenis kopi: Arabika, Robusta, Liberika, Campuran',
               existing_nullable=True)
        batch_op.alter_column('delivery_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='Tanggal pengantaran yang diinginkan',
               existing_nullable=True)
        batch_op.alter_column('notes',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='Catatan tambahan dari pelanggan',
               existing_nullable=True)
        batch_op.drop_index(batch_op.f('idx_orders_created_at'))
        batch_op.drop_index(batch_op.f('idx_orders_payment_status'))
        batch_op.drop_index(batch_op.f('idx_orders_status'))
        batch_op.drop_index(batch_op.f('idx_orders_user_id'))
        batch_op.drop_constraint(batch_op.f('fk_order_user'), type_='foreignkey')
        batch_op.create_foreign_key(None, 'users', ['user_id'], ['id'])
        batch_op.drop_table_comment(
        existing_comment='Tabel untuk menyimpan pesanan jasa sortir kopi'
    )
        batch_op.drop_column('completed_at')
        batch_op.drop_column('machine_id')
        batch_op.drop_column('machine_name')

    with op.batch_alter_table('payment_methods', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('idx_payment_methods_active'))
        batch_op.drop_index(batch_op.f('idx_payment_methods_category'))
        batch_op.drop_constraint(batch_op.f('unique_payment_method'), type_='unique')

    with op.batch_alter_table('payments', schema=None) as batch_op:
        batch_op.alter_column('proof_image',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='Base64 atau file path bukti transfer',
               existing_nullable=False)
        batch_op.drop_index(batch_op.f('idx_payments_order_id'))
        batch_op.drop_index(batch_op.f('idx_payments_status'))
        batch_op.drop_index(batch_op.f('idx_payments_uploaded_at'))
        batch_op.drop_index(batch_op.f('idx_payments_user_id'))
        batch_op.drop_table_comment(
        existing_comment='Tabel pembayaran user'
    )

    with op.batch_alter_table('performance_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('idx_performance_timestamp'))

    with op.batch_alter_table('sorting_batches', schema=None) as batch_op:
        batch_op.add_column(sa.Column('machine_id', sa.String(length=50), nullable=True))
        batch_op.create_foreign_key(None, 'machines', ['machine_id'], ['id'])

    with op.batch_alter_table('sorting_results', schema=None) as batch_op:
        batch_op.add_column(sa.Column('machine_id', sa.String(length=50), nullable=True))
        batch_op.drop_index(batch_op.f('idx_sorting_order_id'))
        batch_op.drop_index(batch_op.f('idx_sorting_sorted_at'))
        batch_op.drop_index(batch_op.f('idx_sorting_user_id'))
        batch_op.drop_constraint(batch_op.f('fk_sorting_user'), type_='foreignkey')
        batch_op.create_foreign_key(None, 'users', ['user_id'], ['id'])
        batch_op.create_foreign_key(None, 'machines', ['machine_id'], ['id'])
        batch_op.create_foreign_key(None, 'orders', ['order_id'], ['id'])

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('sorting_results', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key(batch_op.f('fk_sorting_user'), 'users', ['user_id'], ['id'], ondelete='CASCADE')
        batch_op.create_index(batch_op.f('idx_sorting_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_sorting_sorted_at'), [sa.literal_column('sorted_at DESC')], unique=False)
        batch_op.create_index(batch_op.f('idx_sorting_order_id'), ['order_id'], unique=False)
        batch_op.drop_column('machine_id')

    with op.batch_alter_table('sorting_batches', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_column('machine_id')

    with op.batch_alter_table('performance_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('idx_performance_timestamp'), ['timestamp'], unique=False)

    with op.batch_alter_table('payments', schema=None) as batch_op:
        batch_op.create_table_comment(
        'Tabel pembayaran user',
        existing_comment=None
    )
        batch_op.create_index(batch_op.f('idx_payments_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_payments_uploaded_at'), ['uploaded_at'], unique=False)
        batch_op.create_index(batch_op.f('idx_payments_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_payments_order_id'), ['order_id'], unique=False)
        batch_op.alter_column('proof_image',
               existing_type=sa.TEXT(),
               comment='Base64 atau file path bukti transfer',
               existing_nullable=False)

    with op.batch_alter_table('payment_methods', schema=None) as batch_op:
        batch_op.create_unique_constraint(batch_op.f('unique_payment_method'), ['category', 'name'], postgresql_nulls_not_distinct=False)
        batch_op.create_index(batch_op.f('idx_payment_methods_category'), ['category'], unique=False)
        batch_op.create_index(batch_op.f('idx_payment_methods_active'), ['is_active'], unique=False)

    with op.batch_alter_table('orders', schema=None) as batch_op:
        batch_op.add_column(sa.Column('machine_name', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('machine_id', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('completed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
        batch_op.create_table_comment(
        'Tabel untuk menyimpan pesanan jasa sortir kopi',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key(batch_op.f('fk_order_user'), 'users', ['user_id'], ['id'], ondelete='CASCADE')
        batch_op.create_index(batch_op.f('idx_orders_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_orders_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_orders_payment_status'), ['payment_status'], unique=False)
        batch_op.create_index(batch_op.f('idx_orders_created_at'), ['created_at'], unique=False)
        batch_op.alter_column('notes',
               existing_type=sa.TEXT(),
               comment='Catatan tambahan dari pelanggan',
               existing_nullable=True)
        batch_op.alter_column('delivery_date',
               existing_type=sa.DATE(),
               comment='Tanggal pengantaran yang diinginkan',
               existing_nullable=True)
        batch_op.alter_column('coffee_type',
               existing_type=sa.VARCHAR(length=50),
               comment='Jenis kopi: Arabika, Robusta, Liberika, Campuran',
               existing_nullable=True)
        batch_op.alter_column('customer_address',
               existing_type=sa.TEXT(),
               comment='Alamat lengkap untuk pickup/delivery',
               existing_nullable=True)
        batch_op.alter_column('customer_email',
               existing_type=sa.VARCHAR(length=255),
               comment='Email pelanggan',
               existing_nullable=True)
        batch_op.alter_column('customer_phone',
               existing_type=sa.VARCHAR(length=50),
               comment='Nomor telepon/WhatsApp pelanggan',
               existing_nullable=True)
        batch_op.alter_column('customer_name',
               existing_type=sa.VARCHAR(length=255),
               comment='Nama lengkap pelanggan',
               existing_nullable=True)
        batch_op.alter_column('payment_status',
               existing_type=sa.String(length=20),
               type_=sa.VARCHAR(length=50),
               existing_nullable=True,
               existing_server_default=sa.text("'unpaid'::character varying"))
        batch_op.alter_column('status',
               existing_type=sa.String(length=20),
               type_=sa.VARCHAR(length=50),
               existing_nullable=True,
               existing_server_default=sa.text("'pending'::character varying"))
        batch_op.alter_column('price',
               existing_type=sa.Float(),
               type_=sa.NUMERIC(precision=15, scale=2),
               existing_nullable=False)
        batch_op.alter_column('weight',
               existing_type=sa.Float(),
               type_=sa.NUMERIC(precision=10, scale=2),
               comment='Berat biji kopi (kg)',
               existing_nullable=False)
        batch_op.alter_column('package_name',
               existing_type=sa.VARCHAR(length=100),
               comment='Paket: Starter, Bisnis, Enterprise',
               existing_nullable=False)

    with op.batch_alter_table('notifications', schema=None) as batch_op:
        batch_op.alter_column('link',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=500),
               existing_nullable=True)
        batch_op.alter_column('type',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=30),
               nullable=False)
        batch_op.alter_column('title',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=500),
               existing_nullable=False)

    with op.batch_alter_table('news', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='unique')
        batch_op.create_index(batch_op.f('idx_slug'), ['slug'], unique=False)
        batch_op.create_index(batch_op.f('idx_published_at'), ['published_at'], unique=False)
        batch_op.create_index(batch_op.f('idx_published'), ['is_published'], unique=False)
        batch_op.create_index(batch_op.f('idx_category'), ['category'], unique=False)
        batch_op.create_index(batch_op.f('idx_author_id'), ['author_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_author'), ['author_name'], unique=False)
        batch_op.alter_column('slug',
               existing_type=sa.String(length=500),
               type_=sa.VARCHAR(length=255),
               existing_nullable=True)
        batch_op.alter_column('category',
               existing_type=sa.String(length=20),
               type_=sa.VARCHAR(length=50),
               existing_nullable=False)
        batch_op.alter_column('author_name',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=100),
               existing_nullable=False)
        batch_op.alter_column('author_id',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=36),
               nullable=True)
        batch_op.alter_column('excerpt',
               existing_type=sa.String(length=500),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('title',
               existing_type=sa.String(length=500),
               type_=sa.VARCHAR(length=255),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=36),
               existing_nullable=False)

    with op.batch_alter_table('forum_threads', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_index(batch_op.f('idx_threads_views_count'), [sa.literal_column('views_count DESC')], unique=False)
        batch_op.create_index(batch_op.f('idx_threads_last_activity'), [sa.literal_column('last_activity DESC')], unique=False)
        batch_op.create_index(batch_op.f('idx_threads_is_pinned'), ['is_pinned'], unique=False)
        batch_op.create_index(batch_op.f('idx_threads_is_locked'), ['is_locked'], unique=False)
        batch_op.create_index(batch_op.f('idx_threads_created_at'), [sa.literal_column('created_at DESC')], unique=False)
        batch_op.create_index(batch_op.f('idx_threads_category'), ['category'], unique=False)
        batch_op.create_index(batch_op.f('idx_threads_author_id'), ['author_id'], unique=False)
        batch_op.alter_column('category',
               existing_type=sa.String(length=20),
               type_=sa.VARCHAR(length=50),
               existing_nullable=False)
        batch_op.alter_column('author_role',
               existing_type=sa.String(length=10),
               type_=sa.VARCHAR(length=20),
               existing_nullable=False)
        batch_op.alter_column('author_name',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=100),
               existing_nullable=False)
        batch_op.alter_column('author_id',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=36),
               existing_nullable=False)
        batch_op.alter_column('title',
               existing_type=sa.String(length=500),
               type_=sa.VARCHAR(length=255),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=36),
               existing_nullable=False)

    with op.batch_alter_table('forum_messages', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_index(batch_op.f('idx_messages_thread_id'), ['thread_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_messages_parent_id'), ['parent_message_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_messages_created_at'), [sa.literal_column('created_at DESC')], unique=False)
        batch_op.create_index(batch_op.f('idx_messages_author_id'), ['author_id'], unique=False)
        batch_op.alter_column('parent_message_id',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=36),
               existing_nullable=True)
        batch_op.alter_column('author_role',
               existing_type=sa.String(length=10),
               type_=sa.VARCHAR(length=20),
               existing_nullable=False)
        batch_op.alter_column('author_name',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=100),
               existing_nullable=False)
        batch_op.alter_column('author_id',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=36),
               existing_nullable=False)
        batch_op.alter_column('thread_id',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=36),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=36),
               existing_nullable=False)

    with op.batch_alter_table('forum_message_likes', schema=None) as batch_op:
        batch_op.drop_constraint('unique_message_like', type_='unique')
        batch_op.create_index(batch_op.f('idx_forum_message_likes_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_forum_message_likes_message_id'), ['message_id'], unique=False)
        batch_op.create_unique_constraint(batch_op.f('forum_message_likes_message_id_user_id_key'), ['message_id', 'user_id'], postgresql_nulls_not_distinct=False)
        batch_op.alter_column('id',
               existing_type=sa.BigInteger(),
               type_=sa.INTEGER(),
               existing_nullable=False,
               autoincrement=True)

    op.create_table('forum_likes',
    sa.Column('id', sa.VARCHAR(length=36), autoincrement=False, nullable=False),
    sa.Column('message_id', sa.VARCHAR(length=36), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(length=36), autoincrement=False, nullable=False),
    sa.Column('user_name', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['message_id'], ['forum_messages.id'], name=op.f('forum_likes_message_id_fkey'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('forum_likes_pkey')),
    sa.UniqueConstraint('message_id', 'user_id', name=op.f('forum_likes_message_id_user_id_key'), postgresql_include=[], postgresql_nulls_not_distinct=False)
    )
    with op.batch_alter_table('forum_likes', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('idx_likes_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_likes_message_id'), ['message_id'], unique=False)

    # ### end Alembic commands ###
